<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ログイン</title>
    <script src="js/jquery-3.6.3.min.js"></script>
    <script src="js/jquery.cookie-1.4.1.min.js"></script>
    <link rel="stylesheet" href="css/base.css">
</head>
<body>
<form action="/device/login">
    <div id="loginContainer">
        <h2>ログイン</h2>
        <div class="marginGap">
            <label for="userId">
                ユーザー名
            </label>
            <input id="userId" name="userId" type="text" class="marginLeft">

        </div>
        <div class="marginGap">
            <label for="password">
                パスワード
            </label>
            <input id="password" name="password" type="password" class="marginLeft">
        </div>
        <div class="marginGap">
            <input type="submit" value="送信">
        </div>
    </div>
</form>
</body>
<script>
    function getFormData($form) {
        var unindexed_array = $form.serializeArray();
        var indexed_array = {};

        $.map(unindexed_array, function (n, i) {
            indexed_array[n['name']] = n['value'];
        });

        return indexed_array;
    }

    function ajaxLogin() {
        var $form = $("form");
        var actionUrl = $form.attr('action');
        // var actionUrl = "https://eopz8ly41cg8q6s.m.pipedream.net";
        // let data = $form.serialize();
        let data = getFormData($form);

        $.ajax({
            type: "POST",
            url: actionUrl + '?' + $.param(data),
            // data: $form.serialize(), // serializes the form's elements.
            // data: getFormData($form),
            dataType: "json",
            data: {
                data: data
            }, // serializes the form's elements.
            success: function (data) {
                if (data && !data.ret && !isNaN(data.ret)) {
                    $.cookie("loginState",true,10*60*24)
                    window.location.href = "index.html";
                }else {
                    alert("ログイン失敗！".concat(!!data.msg?data.msg:""));
                }
            },
            error:function (data) {
                alert("ログイン失敗！".concat(!!data.msg?data.msg:""));
            }
        })
    }

    $("form").submit(function(event) {
        event.preventDefault();
        ajaxLogin();
        // return false;
    })
</script>
</html>